<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trust Simulator - Interactive Game Theory</title>
    <link rel="icon" href="favicon.svg" type="image/svg+xml">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>🤝</text></svg>">
    <!-- Brand Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@300;400;500&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.7.0/p5.min.js"></script>
</head>
<body>
    <div id="app">
        <header>
            <h1 class="site-title" onclick="gameController.goToHome()">Trust Simulator</h1>
            <p class="subtitle">An interactive simulation of the game theory of cooperation</p>
        </header>

        <main id="game-container">
            <!-- Tutorial Section -->
            <section id="tutorial" class="game-section active">
                <h2>Why?</h2>

                <p class="concept-intro">
                    Explore one of the most fascinating puzzles in game theory: <strong>when should you trust, and when should you betray?</strong>
                </p>

                <h2>What?</h2>
                <div class="concept-grid">
                    <div class="concept-card">
                        <span class="concept-card-icon">⚖️</span>
                        <h3>The Dilemma</h3>
                        <p>Two players independently choose: cooperate or defect. Cooperation benefits both, but defection offers a higher personal payoff—at your partner's expense. The catch? If both defect, both lose.</p>
                    </div>

                    <div class="concept-card">
                        <span class="concept-card-icon">💎</span>
                        <h3>The Payoffs</h3>
                        <p>Mutual cooperation earns +3 each. Mutual defection earns only +1 each. But if you defect while they cooperate, you get +5 and they get nothing. The temptation to betray is strong—but risky.</p>
                    </div>

                    <div class="concept-card">
                        <span class="concept-card-icon">🌍</span>
                        <h3>Why It Matters</h3>
                        <p>This simple dynamic appears everywhere: climate agreements, business partnerships, international relations, and everyday social interactions. It's the fundamental tension between individual gain and collective good.</p>
                    </div>

                    <div class="concept-card">
                        <span class="concept-card-icon">🔄</span>
                        <h3>Repeated Interactions</h3>
                        <p>When the game repeats, everything changes. Strategies emerge: some always cooperate, others always defect, some retaliate when betrayed, others forgive. Reputation matters. History matters.</p>
                    </div>

                    <div class="concept-card">
                        <span class="concept-card-icon">🎭</span>
                        <h3>Competing Strategies</h3>
                        <p>Meet different AI opponents: the eternal optimist who always trusts, the cynic who never does, the reciprocator who mirrors your moves, and the grudge-holder who never forgives. Each has strengths and weaknesses.</p>
                    </div>

                    <div class="concept-card">
                        <span class="concept-card-icon">🔬</span>
                        <h3>Experiment & Discover</h3>
                        <p>Test your strategies against different AI opponents in the game, then experiment in the sandbox to see how different payoff structures and parameters affect which strategies succeed or fail.</p>
                    </div>
                </div>

                <div class="key-insight">
                    <div class="key-insight-label">The Central Question</div>
                    <div class="key-insight-text">When does cooperation emerge, and when does it collapse?</div>
                </div>

                <div class="landing-options">
                    <h3>How?</h3>
                    <div class="option-cards">
                        <div class="option-card">
                            <div class="option-emoji">🎮</div>
                            <h4>Play the Game</h4>
                            <p>Face different AI strategies and learn their patterns</p>
                            <button class="btn-primary" onclick="gameController.navigateTo('play')">Start Playing</button>
                        </div>
                        <div class="option-card">
                            <div class="option-emoji">🔬</div>
                            <h4>Sandbox Mode</h4>
                            <p>Experiment with custom parameters and conditions</p>
                            <button class="btn-primary" onclick="gameController.navigateTo('sandbox')">Open Sandbox</button>
                        </div>
                    </div>
                </div>

                <div class="multiplayer-section">
                    <h3>🌐 Web3 Multiplayer</h3>
                    <div class="multiplayer-intro">
                        <p><strong>A web3 social experiment about cooperation, betrayal, and skin-in-the-game.</strong></p>
                        <p>Play against real opponents with real stakes. Connect your wallet, stake 0.001 ETH, and compete in a 10-round prisoner's dilemma. Winner takes all. Blockchain makes <em>trustless</em> systems possible—but can it also help us rebuild <em>trustworthy</em> ones?</p>
                        <button class="btn-crypto" onclick="gameController.navigateTo('multiplayer')">🔗 Connect & Play</button>
                    </div>
                </div>
            </section>

            <!-- Playground Section -->
            <section id="playground" class="game-section">
                <div class="payoff-matrix">
                    <h3>Payoff Matrix <span id="custom-params-indicator" style="display: none; color: var(--iris); font-size: 0.8em;">(Custom Settings)</span></h3>
                    <table>
                        <tr>
                            <th></th>
                            <th>Opponent Cooperates</th>
                            <th>Opponent Defects</th>
                        </tr>
                        <tr>
                            <th>You Cooperate</th>
                            <td class="both-cooperate"><span id="playground-both-cooperate">+3 / +3</span></td>
                            <td class="sucker"><span id="playground-sucker">0 / +5</span></td>
                        </tr>
                        <tr>
                            <th>You Defect</th>
                            <td class="temptation"><span id="playground-temptation">+5 / 0</span></td>
                            <td class="both-defect"><span id="playground-both-defect">+1 / +1</span></td>
                        </tr>
                    </table>
                </div>

                <h2>You are playing against..</h2>

                <div class="strategy-intro">
                    <h3 id="opponent-name">Opponent</h3>
                    <div class="narrative-text">
                        <p id="strategy-description">Let's play against different strategies...</p>
                    </div>
                </div>

                <div class="game-board">
                    <div class="player-area">
                        <h3>You</h3>
                        <div id="player-visual" class="agent-visual"></div>
                        <div class="score">Score: <span id="player-score">0</span></div>
                    </div>

                    <div class="vs-area">
                        <div id="round-info">Round <span id="current-round">1</span> / <span id="total-rounds">7</span></div>
                        <div id="last-result"></div>
                    </div>

                    <div class="opponent-area">
                        <h3>Opponent</h3>
                        <div id="opponent-visual" class="agent-visual"></div>
                        <div class="score">Score: <span id="opponent-score">0</span></div>
                    </div>
                </div>

                <div class="history-container">
                    <h4>History</h4>
                    <div id="history-display"></div>
                </div>

                <div class="action-buttons">
                    <button id="cooperate-btn" class="btn-cooperate" onclick="gameController.playerMove('cooperate')">
                        🤝 Cooperate
                    </button>
                    <button id="defect-btn" class="btn-defect" onclick="gameController.playerMove('defect')">
                        💔 Defect
                    </button>
                </div>

                <button id="next-strategy-btn" class="btn-secondary" style="display: none;" onclick="gameController.nextStrategy()">
                    Next Strategy
                </button>
            </section>

            <!-- Sandbox Section -->
            <section id="sandbox" class="game-section">
                <div class="sandbox-header">
                    <h2>Sandbox Mode</h2>
                    <div class="sandbox-header-actions">
                        <button class="btn-primary" onclick="gameController.playWithCustomParams()">🎮 Play with These Settings</button>
                        <button class="btn-secondary" id="copy-link-btn" onclick="gameController.copySettingsLink()">🔗 Copy Link</button>
                    </div>
                </div>
                <div class="narrative-text">
                    <p>Experiment with different parameters to see how they shape the evolution of cooperation. Each setting creates a different environment where strategies must adapt and compete.</p>
                </div>

                <div class="payoff-matrix-config">
                    <h3>Configure Payoff Matrix</h3>
                    <p class="param-description">Adjust the rewards for each outcome. The classic prisoner's dilemma requires: Temptation > Reward > Punishment > Sucker (T > R > P > S).</p>
                    <div class="payoff-grid">
                        <div class="payoff-input">
                            <label>
                                <span class="payoff-label">Both Cooperate (Reward)</span>
                                <input type="number" id="payoff-reward" min="0" max="10" value="3" step="1">
                            </label>
                        </div>
                        <div class="payoff-input">
                            <label>
                                <span class="payoff-label">Cooperate vs Defect (Sucker)</span>
                                <input type="number" id="payoff-sucker" min="0" max="10" value="0" step="1">
                            </label>
                        </div>
                        <div class="payoff-input">
                            <label>
                                <span class="payoff-label">Defect vs Cooperate (Temptation)</span>
                                <input type="number" id="payoff-temptation" min="0" max="10" value="5" step="1">
                            </label>
                        </div>
                        <div class="payoff-input">
                            <label>
                                <span class="payoff-label">Both Defect (Punishment)</span>
                                <input type="number" id="payoff-punishment" min="0" max="10" value="1" step="1">
                            </label>
                        </div>
                    </div>
                    <div class="payoff-matrix">
                        <h4>Current Matrix</h4>
                        <table>
                            <tr>
                                <th></th>
                                <th>Opponent Cooperates</th>
                                <th>Opponent Defects</th>
                            </tr>
                            <tr>
                                <th>You Cooperate</th>
                                <td class="both-cooperate"><span id="display-reward">+3</span> / <span id="display-reward-2">+3</span></td>
                                <td class="sucker"><span id="display-sucker">0</span> / <span id="display-temptation-2">+5</span></td>
                            </tr>
                            <tr>
                                <th>You Defect</th>
                                <td class="temptation"><span id="display-temptation">+5</span> / <span id="display-sucker-2">0</span></td>
                                <td class="both-defect"><span id="display-punishment">+1</span> / <span id="display-punishment-2">+1</span></td>
                            </tr>
                        </table>
                    </div>
                </div>

                <div class="sandbox-controls">
                    <div class="control-group">
                        <label>
                            <strong>Population Size: <span id="sandbox-pop-value">100</span></strong>
                            <span class="param-description">Total number of agents competing in the simulation. Larger populations create more diverse ecosystems but take longer to evolve.</span>
                        </label>
                        <input type="range" id="sandbox-population" min="20" max="200" value="100" step="10">
                    </div>
                    <div class="control-group">
                        <label>
                            <strong>Rounds per Match: <span id="sandbox-rounds-value">7</span></strong>
                            <span class="param-description">How many times each pair of agents interact. More rounds allow complex strategies like Tit for Tat to prove their worth, while fewer rounds favor simple strategies.</span>
                        </label>
                        <input type="range" id="sandbox-rounds" min="3" max="20" value="7">
                    </div>
                    <div class="control-group">
                        <label>
                            <strong>Mutation Rate: <span id="sandbox-mutation-value">5</span>%</strong>
                            <span class="param-description">Chance that an agent randomly changes strategy when reproducing. Higher rates maintain diversity but disrupt stable populations. Zero creates pure competition.</span>
                        </label>
                        <input type="range" id="sandbox-mutation" min="0" max="20" value="5">
                    </div>
                    <div class="control-group">
                        <label>
                            <strong>Noise Rate: <span id="sandbox-noise-value">2</span>%</strong>
                            <span class="param-description">Probability that an agent makes a mistake (cooperates when they meant to defect, or vice versa). Higher noise makes cooperation harder and punishes unforgiving strategies.</span>
                        </label>
                        <input type="range" id="sandbox-noise" min="0" max="10" value="2">
                    </div>
                </div>

                <div class="sandbox-buttons">
                    <button class="btn-primary" onclick="gameController.runSandboxSimulation()">Run Simulation</button>
                    <button class="btn-secondary" onclick="gameController.resetSandbox()">Reset</button>
                    <button id="toggle-sandbox-log-btn" class="btn-secondary" onclick="gameController.toggleSandboxLog()">📊 Show Match Log</button>
                </div>

                <div class="sandbox-stats">
                    <div>Generation: <span id="sandbox-generation">0</span> / 50</div>
                    <div>Population: <span id="sandbox-population-size">100</span></div>
                    <div>Status: <span id="sandbox-status">Ready</span></div>
                </div>

                <div id="sandbox-log-container" class="hidden">
                    <h4>Match Log</h4>
                    <div id="sandbox-log" class="sandbox-log"></div>
                </div>

                <div id="sandbox-population-chart"></div>

                <div id="sandbox-results"></div>
            </section>

            <!-- Multiplayer Section -->
            <section id="multiplayer" class="game-section crypto-section">
                <!-- Connect Wallet Screen -->
                <div id="crypto-connect" class="crypto-screen active">
                    <div class="crypto-hero">
                        <h2>🌐 Multiplayer mode</h2>
                        <p class="crypto-tagline">A web3 social experiment about cooperation, betrayal, and skin-in-the-game.</p>
                    </div>

                    <div class="crypto-explainer">
                        <h3>How It Works</h3>
                        <div class="crypto-steps">
                            <div class="crypto-step">
                                <div class="step-number">1</div>
                                <div class="step-content">
                                    <h4>Connect & Stake</h4>
                                    <p>Connect your Ethereum wallet and stake 0.001 ETH to join the game</p>
                                </div>
                            </div>
                            <div class="crypto-step">
                                <div class="step-number">2</div>
                                <div class="step-content">
                                    <h4>Get Matched</h4>
                                    <p>Wait to be matched with another player who's also staked</p>
                                </div>
                            </div>
                            <div class="crypto-step">
                                <div class="step-number">3</div>
                                <div class="step-content">
                                    <h4>Play 10 Rounds</h4>
                                    <p>Choose to Trust or Cheat each round. Your choices affect both scores</p>
                                </div>
                            </div>
                            <div class="crypto-step">
                                <div class="step-number">4</div>
                                <div class="step-content">
                                    <h4>Winner Takes All</h4>
                                    <p>Highest score wins 0.002 ETH. Tie? Funds split evenly</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="wallet-connect-container">
                        <button id="connect-wallet-btn" class="btn-crypto btn-large" onclick="cryptoGame.connectWallet()">
                            🔗 Connect Wallet to Play
                        </button>
                        <p class="wallet-status" id="wallet-status">No wallet connected</p>
                        <p class="network-info">Required Network: <strong>Base Sepolia</strong></p>
                    </div>



                    <!-- My Games Section -->
                    <div class="my-games-section">
                        <h3>🎮 My Games</h3>
                        <div id="my-games-container">
                            <p class="loading-history">Connect wallet to view your games</p>
                        </div>
                    </div>

                    <!-- Game History Section -->
                    <div class="game-history-section">
                        <h3>📜 Recent Games</h3>
                        <div id="game-history-container">
                            <p class="loading-history">Connect wallet to view game history</p>
                        </div>
                    </div>
                </div>

                <!-- Lobby Screen -->
                <div id="crypto-lobby" class="crypto-screen">
                    <h2>⏳ Waiting for Opponent...</h2>
                    <div class="lobby-info">
                        <p>Your stake: <strong>0.001 ETH</strong></p>
                        <p>Your address: <span id="player-address">0x...</span></p>
                        <p id="game-id-display">Game ID: <span id="current-game-id">--</span></p>
                    </div>
                    <div class="lobby-spinner">
                        <div class="spinner"></div>
                        <p>Searching for an opponent who's also staked...</p>
                    </div>
                    <div class="lobby-actions">
                        <button class="btn-secondary" onclick="cryptoGame.cancelGame()">Cancel & Withdraw</button>
                    </div>
                </div>

                <!-- Game Board Screen -->
                <div id="crypto-game" class="crypto-screen">
                    <div class="crypto-game-header">
                        <h2>Round <span id="crypto-round">1</span> / 10</h2>
                        <div class="educational-snippet" id="educational-snippet">
                            <p>Choose wisely. Your opponent is choosing simultaneously.</p>
                        </div>
                    </div>

                    <div class="crypto-game-board">
                        <div class="crypto-player-area">
                            <div class="player-identity">
                                <div class="player-avatar">👤</div>
                                <div class="player-info">
                                    <div class="player-label">You</div>
                                    <div class="player-ens" id="player-ens">0x...</div>
                                </div>
                            </div>
                            <div class="player-score-display">
                                Score: <span id="crypto-player-score">0</span>
                            </div>
                        </div>

                        <div class="crypto-vs-area">
                            <div id="crypto-round-result" class="round-result"></div>
                        </div>

                        <div class="crypto-opponent-area">
                            <div class="player-identity">
                                <div class="player-avatar">🎭</div>
                                <div class="player-info">
                                    <div class="player-label">Opponent</div>
                                    <div class="player-ens" id="opponent-ens">0x...</div>
                                </div>
                            </div>
                            <div class="player-score-display">
                                Score: <span id="crypto-opponent-score">0</span>
                            </div>
                        </div>
                    </div>

                    <div class="crypto-history">
                        <h4>Round History</h4>
                        <div id="crypto-history-display"></div>
                    </div>

                    <div class="crypto-action-buttons">
                        <button id="trust-btn" class="btn-trust btn-large" onclick="cryptoGame.submitMove(true)">
                            🤝 Trust
                        </button>
                        <button id="cheat-btn" class="btn-cheat btn-large" onclick="cryptoGame.submitMove(false)">
                            💔 Cheat
                        </button>
                    </div>

                    <div id="waiting-message" class="waiting-message" style="display: none;">
                        Waiting for opponent's move...
                    </div>
                </div>

                <!-- Results Screen -->
                <div id="crypto-results" class="crypto-screen">
                    <h2 id="game-outcome-title">🎉 Game Complete!</h2>

                    <div class="crypto-results-summary">
                        <div class="result-card">
                            <div class="result-label">Your Score</div>
                            <div class="result-value" id="final-player-score">0</div>
                        </div>
                        <div class="result-card">
                            <div class="result-label">Opponent Score</div>
                            <div class="result-value" id="final-opponent-score">0</div>
                        </div>
                        <div class="result-card highlight">
                            <div class="result-label">Prize</div>
                            <div class="result-value">0.002 ETH</div>
                        </div>
                    </div>

                    <div class="payout-status" id="payout-status">
                        <p>Processing payout...</p>
                    </div>

                    <div class="game-reflection">
                        <blockquote>
                            "In crypto, we built systems that don't require trust.<br>
                            The next challenge is building systems that <em>deserve</em> it."
                        </blockquote>
                    </div>

                    <div class="crypto-results-actions">
                        <button class="btn-crypto" onclick="cryptoGame.playAgain()">Play Again</button>
                        <button class="btn-secondary" onclick="cryptoGame.shareResults()">Share Results</button>
                        <button class="btn-secondary" onclick="gameController.goToHome()">Back to Menu</button>
                    </div>
                </div>
            </section>
        </main>

        <footer>
            <p>Inspired by Nicky Case's "<a style="color:white;" href="https://ncase.me/trust/">Evolution of Trust</a>" | Built with game theory and love by ya boiiii <a style="color:white" href="https://x.com/owocoki">@owocki</a></p>
        </footer>
    </div>

    <script src="game.js"></script>
    <script src="app.js"></script>

    <!-- Load ethers.js from CDN before crypto-game -->
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>

    <!-- Initialize crypto game after ethers is loaded -->
    <script src="crypto-game.js"></script>
</body>
</html>
